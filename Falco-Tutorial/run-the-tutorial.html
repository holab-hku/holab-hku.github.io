<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Run the tutorial | Falco Tutorial</title>
  <meta name="description" content="Falco: Single cell RNA-seq parrallelised cloud computing tutorial" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Run the tutorial | Falco Tutorial" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Falco: Single cell RNA-seq parrallelised cloud computing tutorial" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Run the tutorial | Falco Tutorial" />
  
  <meta name="twitter:description" content="Falco: Single cell RNA-seq parrallelised cloud computing tutorial" />
  

<meta name="author" content="Ho Lab" />


<meta name="date" content="2019-12-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="create-ami-for-falco-cluster-nodes.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />












<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About the Workshop</a></li>
<li class="chapter" data-level="2" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>2</b> Getting Started</a><ul>
<li class="chapter" data-level="2.1" data-path="getting-started.html"><a href="getting-started.html#prerequisites"><i class="fa fa-check"></i><b>2.1</b> Prerequisites</a></li>
<li class="chapter" data-level="2.2" data-path="getting-started.html"><a href="getting-started.html#aws-setup"><i class="fa fa-check"></i><b>2.2</b> AWS setup</a><ul>
<li class="chapter" data-level="2.2.1" data-path="getting-started.html"><a href="getting-started.html#aws-account"><i class="fa fa-check"></i><b>2.2.1</b> AWS account</a></li>
<li class="chapter" data-level="2.2.2" data-path="getting-started.html"><a href="getting-started.html#obtain-an-aws-secret-key"><i class="fa fa-check"></i><b>2.2.2</b> Obtain an AWS secret key</a></li>
<li class="chapter" data-level="2.2.3" data-path="getting-started.html"><a href="getting-started.html#install-the-aws-linux-client-aws-cli"><i class="fa fa-check"></i><b>2.2.3</b> Install the AWS Linux Client (AWS CLI)</a></li>
<li class="chapter" data-level="2.2.4" data-path="getting-started.html"><a href="getting-started.html#configuring-aws-linux-client"><i class="fa fa-check"></i><b>2.2.4</b> Configuring AWS Linux Client</a></li>
<li class="chapter" data-level="2.2.5" data-path="getting-started.html"><a href="getting-started.html#obtain-an-aws-ec2-key"><i class="fa fa-check"></i><b>2.2.5</b> Obtain an AWS EC2 key</a></li>
<li class="chapter" data-level="2.2.6" data-path="getting-started.html"><a href="getting-started.html#obtain-access-to-or-create-an-aws-s3-bucket"><i class="fa fa-check"></i><b>2.2.6</b> Obtain access to or create an AWS S3 bucket</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="reference-genome.html"><a href="reference-genome.html"><i class="fa fa-check"></i><b>3</b> Reference Genome</a><ul>
<li class="chapter" data-level="3.1" data-path="reference-genome.html"><a href="reference-genome.html#get-reference-genome-and-the-star-index"><i class="fa fa-check"></i><b>3.1</b> Get reference Genome and the STAR index</a></li>
<li class="chapter" data-level="3.2" data-path="reference-genome.html"><a href="reference-genome.html#sync-the-reference-genome-index-from-s3-bucket"><i class="fa fa-check"></i><b>3.2</b> Sync the reference genome index from s3 bucket</a></li>
<li class="chapter" data-level="3.3" data-path="reference-genome.html"><a href="reference-genome.html#check-reference-genome-index-from-s3-bucket"><i class="fa fa-check"></i><b>3.3</b> Check reference genome index from s3 bucket</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="read-data.html"><a href="read-data.html"><i class="fa fa-check"></i><b>4</b> Read Data</a><ul>
<li class="chapter" data-level="4.1" data-path="read-data.html"><a href="read-data.html#obtain-the-read-data"><i class="fa fa-check"></i><b>4.1</b> Obtain the Read Data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="create-ami-for-falco-cluster-nodes.html"><a href="create-ami-for-falco-cluster-nodes.html"><i class="fa fa-check"></i><b>5</b> Create AMI for Falco cluster nodes</a><ul>
<li class="chapter" data-level="5.1" data-path="create-ami-for-falco-cluster-nodes.html"><a href="create-ami-for-falco-cluster-nodes.html#have-a-look-at-the-custom-ami-for-falco-framework-with-tools-pre-installed"><i class="fa fa-check"></i><b>5.1</b> Have a look at the Custom AMI for Falco framework with tools pre-installed</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html"><i class="fa fa-check"></i><b>6</b> Run the tutorial</a><ul>
<li class="chapter" data-level="6.1" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#give-values-for-s3-bucket-and-user-name"><i class="fa fa-check"></i><b>6.1</b> Give values for S3 bucket and User Name</a></li>
<li class="chapter" data-level="6.2" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#launch-the-aws-emr-cluster"><i class="fa fa-check"></i><b>6.2</b> Launch the AWS EMR cluster</a></li>
<li class="chapter" data-level="6.3" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#monitor-the-emr-cluster"><i class="fa fa-check"></i><b>6.3</b> Monitor the EMR Cluster</a></li>
<li class="chapter" data-level="6.4" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#upload-the-manifest-file"><i class="fa fa-check"></i><b>6.4</b> Upload the Manifest file</a></li>
<li class="chapter" data-level="6.5" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#launch-the-split-job"><i class="fa fa-check"></i><b>6.5</b> Launch the Split job</a></li>
<li class="chapter" data-level="6.6" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#launch-the-pre-processing-job"><i class="fa fa-check"></i><b>6.6</b> Launch the Pre-processing job</a></li>
<li class="chapter" data-level="6.7" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#launch-the-analysis-job"><i class="fa fa-check"></i><b>6.7</b> Launch the Analysis job</a></li>
<li class="chapter" data-level="6.8" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#monitor-steps"><i class="fa fa-check"></i><b>6.8</b> Monitor Steps</a></li>
<li class="chapter" data-level="6.9" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#monitor-s3-files"><i class="fa fa-check"></i><b>6.9</b> Monitor S3 files</a></li>
<li class="chapter" data-level="6.10" data-path="run-the-tutorial.html"><a href="run-the-tutorial.html#download-results-and-terminate-cluster"><i class="fa fa-check"></i><b>6.10</b> Download results and Terminate Cluster</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Falco Tutorial</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="run-the-tutorial" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Run the tutorial</h1>
<p>Change to Falco home directory.</p>
<pre><code>cd $Faclco</code></pre>
<div id="give-values-for-s3-bucket-and-user-name" class="section level2">
<h2><span class="header-section-number">6.1</span> Give values for S3 bucket and User Name</h2>
<p>The tutorial files have a number of locations that have a placeholder called username and yourbucket. Change these placeholders to your values. In a bash shell, from the <em>Falco</em> home directory, edit and submit the following command:[‚ùóÔ∏è]</p>
<pre><code># preplace the bracketed sections with your details
sed -i.bak &#39;s/username/[YOUR USER NAME]/g ; s/yourbucket/[YOUR BUCKET NAME]/g&#39; tutorial/*.config
# EXAMPLE ONLY: if your user name if &quot;fred&quot; and your AWS bucket is &quot;falco-test&quot;, then you would use the following command
#sed -i.bak &#39;s/username/fred/g ; s/yourbucket/falco-test/g&#39; tutorial/*.config</code></pre>
<pre><code>sed -i.bak.reg &#39;s/us-west-2/[YOUR REGION]/g&#39; tutorial/*.config
# change [YOUR REGION] to the name of your region
# EXAMPLE (if your region is us-west-1): sed -i.bak.reg &#39;s/us-west-2/us-west-1/g&#39; tutorial/*.config</code></pre>
<p>The original .config files in the tutorial directory will now have the file extension .config.bak should you wish to restore the original files.</p>
<p>‚ùóFirst open the file tutorial/emr_cluster.config.</p>
<pre><code>vi tutorial/emr_cluster.config</code></pre>
<p>Change the release_label to the latest version:</p>
<pre><code>release_label = emr-5.27.0</code></pre>
<p>Change the bootstrap_scripts to only copy_reference.sh:</p>
<pre><code>bootstrap_scripts = copy_reference.sh</code></pre>
<p>Adding the line in the below:</p>
<pre><code># If custom AMI ID is specified, it is recommended to remove install_software.sh from thr bootstrap scripts as the custom AMI should already have these installed.
custom_ami_id = ami-0f48840896db32bf0</code></pre>
<p>and check that [EMR_nodes] section is similar to the following:</p>
<pre><code>[EMR_nodes]
key_name = yourkey
service_role = EMR_DefaultRole
instance_profile = EMR_EC2_DefaultRole
master_instance_type = m5.4xlarge
master_instance_count = 1
core_instance_type = m5.4xlarge
core_instance_count = 2
core_instance_spot = True
core_instance_bid_price = 1</code></pre>
<p><img src="emr_config.PNG" /><!-- -->
The <code>[EMR_nodes]</code> section contains a line that starts with <code>key_name =</code>. The computing resources created by the AWS EMR framework uses public‚Äìkey cryptography to encrypt and decrypt login information. You need to supply your key name here. For example, if your encryption key file is <code>my-key-name.pem</code>, the corresponding line in the configuration file should read <code>key_name = my-key-name</code>. [‚ùóÔ∏è]Go ahead and edit this entry - enter your key name.[üî¥][ Also be aware of the charges that you may incur from AWS for the creation of this cluster. The master instance will be an on-demand type, whilst the two core instances are spot instance types. It is estimated the cost of the cluster for this tutorial, if terminated within 1 hour, will be less than $5 USD. This cost is based on the AWS region us-west-2 - US West (Oregon).</p>
</div>
<div id="launch-the-aws-emr-cluster" class="section level2">
<h2><span class="header-section-number">6.2</span> Launch the AWS EMR cluster</h2>
<p>When ready, in the home directory of the <em>Falco</em> code, issue the following command to start the cluster: [‚ùóÔ∏è]</p>
<pre><code>python3 launch_cluster.py --config tutorial/emr_cluster.config</code></pre>
<p>When the command is processed, the user will receive a response, of the form:</p>
<pre><code>Cluster has been launched with ID j-1FDPU9CHN79W9</code></pre>
<p>Make a note of your cluster ID for future reference.</p>
</div>
<div id="monitor-the-emr-cluster" class="section level2">
<h2><span class="header-section-number">6.3</span> Monitor the EMR Cluster</h2>
<p>[‚ùóÔ∏è] Monitor the status of the EMR cluster via the AWS EMR console. When the status of your cluster is Ready, you may proceed with the steps required for completing the analysis.</p>
<p>Click on your cluster to obtain more information about your cluster.</p>
<p>[üî¥] Since the nodes that are launched as part of this cluster use AWS spot instance types, it is possible that the market price for the instances exceeds the bid price. If this is the case, then the cluster will not start until the market price falls below the bid price. You can monitor the market price for the spot instances via the AWS EC2 Mangement Console. You can decide if you want to terminate your EMR cluster and either try again later, or modify the bid price in the file <code>tutorial/emr_cluster.config</code>.</p>
</div>
<div id="upload-the-manifest-file" class="section level2">
<h2><span class="header-section-number">6.4</span> Upload the Manifest file</h2>
<p>Falco requires a manifest file to list the FASTQ filenames representing the data input. The required format is a tab delimited text file. This file has been provided for this tutorial and is located at <code>tutorial/data.manifest</code>. Upload the manifest file to your AWS S3 bucket: [‚ùóÔ∏è]</p>
<pre><code># issue this command from the Falco home directory
aws s3 cp tutorial/data.manifest s3://[YOUR BUCKET]/falco-tutorial/data.manifest
# replace [YOUR BUCKET] with the name of your bucket</code></pre>
<p>[üî¥]The following three instructions that launch jobs can be issued one after the other - without waiting for the previous job to finish. The EMR framework will launch jobs in order, and only after the previous job has completed.</p>
</div>
<div id="launch-the-split-job" class="section level2">
<h2><span class="header-section-number">6.5</span> Launch the Split job</h2>
<p>The split job takes the original data and splits it into smaller sized files for more efficient processing by Falco. The original input data stored on AWS S3 will not be removed. The modified data will be stored in a new AWS S3 location as specified in the configuration file <code>tutorial/split_job.config</code>. Type the following command at a command prompt in the Falco home directory:[‚ùóÔ∏è]</p>
<pre><code>python3 submit_split_job.py --config tutorial/split_job.config</code></pre>
</div>
<div id="launch-the-pre-processing-job" class="section level2">
<h2><span class="header-section-number">6.6</span> Launch the Pre-processing job</h2>
<p>In Falco, the pre-processing step is optional. However, for this tutorial, an example pre-processing script is provided, and this step is compulsory to complete the tutorial as configured.</p>
<p>First examine the configuration file <code>tutorial/preprocessing_job.config</code>. The config file specifies which bash scripts are used for the pre-processing. You may wish to also examine these scripts to see how the pre-processing works in this case. Type the following at a command prompt from the Falco home directory: [‚ùóÔ∏è]</p>
<pre><code>python3 submit_preprocessing_job.py --config tutorial/preprocessing_job.config</code></pre>
</div>
<div id="launch-the-analysis-job" class="section level2">
<h2><span class="header-section-number">6.7</span> Launch the Analysis job</h2>
<p>This is the main analysis job that processes the pre-processed data to determine the counts of features. The output be two .csv files: the actual counts of features, and a separate file detailing quality assurance statistics relating to these counts.</p>
<p>The configuration file <code>tutorial/analysis_job.config</code> contains the settings for the analysis job with STAR as the aligner and featureCount for quantification - including any extra parameters for the tools used. The configuration file also specifies the AWS S3 location for the final output .csv files. Enter the following at a command prompt from the Falco home directory: [‚ùóÔ∏è]</p>
<pre><code>python3 submit_analysis_job.py --config tutorial/analysis_job.config</code></pre>
<p>[üî¥] To change the alignment and/or quantification tool used in the analysis job, simply modify the <code>aligner_tool</code> and <code>counter_tool</code> option in the analysis configuration file (<code>analysis_job.config</code>).</p>
</div>
<div id="monitor-steps" class="section level2">
<h2><span class="header-section-number">6.8</span> Monitor Steps</h2>
<p>Note that, as long as the above three steps (split, preprocess, and analysis) are entered in that order, the steps may be entered one after the other - without having to wait until the previous step finishes. The EMR framework ensures that a step does not start until the previously queued step has completed.</p>
<p>[‚ùóÔ∏è] Monitor the status of each step using the AWS EMR console - in the Step section.</p>
</div>
<div id="monitor-s3-files" class="section level2">
<h2><span class="header-section-number">6.9</span> Monitor S3 files</h2>
<p>Use the AWS S3 Console to monitor files in your S3 bucket.</p>
</div>
<div id="download-results-and-terminate-cluster" class="section level2">
<h2><span class="header-section-number">6.10</span> Download results and Terminate Cluster</h2>
<p>To download a file from AWS S3 to your current directory, edit the following command with your details and execute at a shell command line: [‚ùóÔ∏è]</p>
<pre><code>aws s3 cp s3://[YOUR BUCKET]/falco-tutorial/[YOUR USER NAME]/analysis/samples_expression.csv .
# you can also list all the AWS S3 files that begin with a particular prefix:
#aws s3 ls s3://[YOUR BUCKET]/falco-tutorial/[YOUR USER NAME]/analysis/</code></pre>
<p>Alternatively, you could see a listing of the results via the AWS S3 Console by navigating to your bucket and output location.</p>
<p><strong>[üî¥]As AWS charges by the hour for usage of its services, the user should terminate their cluster when finished. This is done by selecting your cluster on the AWS EMR console <em>Cluster List</em>, and clicking the <em>Terminate</em> button.</strong></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="create-ami-for-falco-cluster-nodes.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Falco-tutorial.pdf", "Falco-tutorial.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
